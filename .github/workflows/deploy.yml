name: EC2 ì„œë²„ ë°°í¬

on:
  push:
    branches: [ main ]  # ë©”ì¸ ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
  workflow_dispatch:    # ìˆ˜ë™ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest  # ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ í™˜ê²½
    
    steps:
    - name: 1. í”„ë¡œì íŠ¸ ì €ì¥ì†Œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (checkout)
      uses: actions/checkout@v3  # ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
    
    - name: 2. SSH ì„¤ì •
      run: |
        echo "======= í™˜ê²½ ë³€ìˆ˜======"
        echo "EC2_HOST: ${{ secrets.EC2_HOST }}"
        echo "EC2_PORT: ${{ secrets.EC2_PORT }}"
        echo "======================="
        
        # SSH ì„¤ì •
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key
        chmod 600 ~/.ssh/ec2_key
        # SSH í˜¸ìŠ¤íŠ¸ í‚¤ ê²€ì¦ ìŠ¤í‚µ (ì²« ì ‘ì† ì‹œ í•„ìš”)
        echo -e "Host ${{ secrets.EC2_HOST }}\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
    
    - name: 3. AWS EC2 ë°°í¬
      run: |
        # ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ë³µì‚¬
        rsync -avz --exclude='.git/' --exclude='.github/' --exclude='models/' --exclude='static/' -e "ssh -i ~/.ssh/ec2_key" ./ ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:~/background-remover/
        
        # SSHë¡œ ì ‘ì†í•˜ì—¬ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
          cd ~/background-remover && 
          echo "ë°°í¬ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤..." &&
          
          # ì„œë²„ í™˜ê²½ ì •ë³´ í™•ì¸
          echo "=== ì„œë²„ í™˜ê²½ ì •ë³´ ==="
          echo "í˜¸ìŠ¤íŠ¸ëª…: $(hostname)"
          echo "IP ì£¼ì†Œ: $(hostname -I)"
          echo "======================="
          
          # ëª¨ë¸ ë° static ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ëŠ” ê²½ìš°)
          mkdir -p models static/images logs &&
          
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ë° í™•ì¸
          echo "EC2_HOST=${{ secrets.EC2_HOST }}" > .env
          echo "EC2_PORT=${{ secrets.EC2_PORT }}" >> .env
          echo "í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ í™•ì¸:"
          cat .env
          
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ì‹¤í–‰
          docker-compose -f docker-compose-prod.yml down &&
          docker-compose -f docker-compose-prod.yml build --no-cache &&
          docker-compose -f docker-compose-prod.yml up -d &&
          
          echo "ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        '
    
    - name: 4. ë°°í¬ í™•ì¸
      run: |
        echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."
        sleep 30  # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì‹œê°„

        if curl -s http://${{ secrets.EC2_HOST }}:${{ secrets.EC2_PORT }}/bg-remover/health | grep -q "healthy"; then
          echo "::set-output name=status::success"
          echo "âœ… ë°°í¬ ì„±ê³µ!"
        else
          echo "::set-output name=status::failure"
          echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
        fi

    # ë°°í¬ ê²°ê³¼ Mattermostë¡œ ì „ì†¡
    - name: 5. ê²°ê³¼ ì•Œë¦¼ ì „ì†¡
      if: always()
      run: |
        if [ "${{ steps.verify.outputs.status }}" = "success" ]; then
          STATUS="âœ… ì„±ê³µ"
          EMOJI="ğŸ‰"
        else
          STATUS="âŒ ì‹¤íŒ¨"
          EMOJI="âš ï¸"
        fi
      
        curl -X POST -H 'Content-Type: application/json' --data '{
          "text": "### ğŸ“¢ ë°°í¬ ê²°ê³¼: '"$STATUS"'\n**ì €ì¥ì†Œ:** ${{ github.repository }}\n**ë¸Œëœì¹˜:** ${{ github.ref_name }}\n**ì»¤ë°‹:** ${{ github.sha }}\n**ë©”ì‹œì§€:** ${{ github.event.head_commit.message }}\n**ì‹¤í–‰ì:** ${{ github.actor }}\n**ìƒíƒœ:** '"$STATUS $EMOJI"'\n**ë°°í¬ ë§í¬:** [GitHub Actions ì‹¤í–‰ ê²°ê³¼](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        }' ${{ secrets.MATTERMOST_WEBHOOK_URL }}
