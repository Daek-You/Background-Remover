name: EC2 ì„œë²„ ë°°í¬

on:
  push:
    branches: [ main ]  # ë©”ì¸ ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
  workflow_dispatch:     # ìˆ˜ë™ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest  # ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ í™˜ê²½

    steps:
    - name: 1. í”„ë¡œì íŠ¸ ì €ì¥ì†Œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (checkout)
      uses: actions/checkout@v3  # ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ

    - name: 2. SSH ì„¤ì •
      run: |
        # SSH ì„¤ì •
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key
        chmod 600 ~/.ssh/ec2_key

        # SSH í˜¸ìŠ¤íŠ¸ í‚¤ ê²€ì¦ ìŠ¤í‚µ (ì²« ì ‘ì† ì‹œ í•„ìš”)
        echo -e "Host ${{ secrets.EC2_HOST }}\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config

    - name: 3. EC2 ì„œë²„ ë””ìŠ¤í¬ ê³µê°„ í™•ë³´
      run: |
        # SSHë¡œ ì ‘ì†í•˜ì—¬ ë””ìŠ¤í¬ ê³µê°„ í™•ì¸ ë° ì •ë¦¬
        ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=5 -i ~/.ssh/ec2_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
          echo "===== ë””ìŠ¤í¬ ê³µê°„ í™•ì¸ (ì •ë¦¬ ì „) ====="
          df -h | grep -v tmpfs

          echo "===== ë„ì»¤ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì‹œì‘ ====="

          # ì¤‘ì§€ëœ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          echo "ì¤‘ì§€ëœ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
          docker container prune -f

          # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì´ë¯¸ì§€ì™€ ê´€ë ¨ ì—†ëŠ” ëŒ•ê¸€ë§(dangling) ì´ë¯¸ì§€ë§Œ ì •ë¦¬
          echo "ëŒ•ê¸€ë§ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
          docker image prune -f

          # 30ì¼ ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šì€ ë³¼ë¥¨ ì •ë¦¬
          echo "ì˜¤ë˜ëœ ë³¼ë¥¨ ì •ë¦¬ ì¤‘..."
          docker volume prune -f

          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë„¤íŠ¸ì›Œí¬ ì •ë¦¬
          echo "ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë„¤íŠ¸ì›Œí¬ ì •ë¦¬ ì¤‘..."
          docker network prune -f

          # bg-remover ê´€ë ¨ ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬ (ìµœì‹  3ê°œ ìœ ì§€)
          echo "ì´ì „ ë²„ì „ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
          docker images | grep "bg-remover" | sort -k2 -r | tail -n +4 | awk '\''{print $3}'\'' | xargs -r docker rmi

          echo "===== ë„ì»¤ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì™„ë£Œ ====="

          # ì •ë¦¬ í›„ ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
          echo "===== ë””ìŠ¤í¬ ê³µê°„ í™•ì¸ (ì •ë¦¬ í›„) ====="
          df -h | grep -v tmpfs
        '

    - name: 4. AWS EC2 ë°°í¬
      run: |
        # ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ë³µì‚¬
        rsync -avz --exclude='.git/' --exclude='.github/' --exclude='models/' --exclude='static/' -e "ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=5 -i ~/.ssh/ec2_key" ./ ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:~/background-remover/

        # SSHë¡œ ì ‘ì†í•˜ì—¬ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=5 -i ~/.ssh/ec2_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
          cd ~/background-remover &&
          echo "ë°°í¬ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤..." &&

          # ëª¨ë¸ ë° static ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ëŠ” ê²½ìš°)
          mkdir -p models static/images logs &&

          # Docker Buildx ì„¤ì¹˜ (ì—†ëŠ” ê²½ìš°)
          echo "Docker Buildx ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜..."
          if ! docker buildx version &> /dev/null; then
            echo "Docker Buildx ì„¤ì¹˜ ì¤‘..."
            mkdir -p ~/.docker/cli-plugins

            # ìµœì‹  Docker Buildx í”ŒëŸ¬ê·¸ì¸ ë‹¤ìš´ë¡œë“œ
            BUILDX_URL=$(curl -s https://api.github.com/repos/docker/buildx/releases/latest | grep "browser_download_url.*linux-amd64" | cut -d : -f 2,3 | tr -d \")
            curl -L "${BUILDX_URL}" -o ~/.docker/cli-plugins/docker-buildx
            chmod +x ~/.docker/cli-plugins/docker-buildx

            # ì„¤ì¹˜ í™•ì¸
            docker buildx version

            # Buildx ë¹Œë” ìƒì„± ë° ì‚¬ìš© ì„¤ì •
            docker buildx create --name mybuilder --use
            docker buildx inspect --bootstrap
          else
            echo "Docker Buildxê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
            docker buildx version
          fi

          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ë° í™•ì¸
          echo "EC2_HOST=${{ secrets.EC2_HOST }}" > .env
          echo "EC2_PORT=${{ secrets.EC2_PORT }}" >> .env
          echo "DOCKER_BUILDKIT=1" >> .env
          echo "í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ í™•ì¸:"
          cat .env

          # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ì‹¤í–‰
          export DOCKER_BUILDKIT=1
          docker-compose -f docker-compose-prod.yml down &&
          docker-compose -f docker-compose-prod.yml build --no-cache &&
          docker-compose -f docker-compose-prod.yml up -d &&

          echo "ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        '

    - name: 5. ë°°í¬ í™•ì¸
      id: verify
      run: |
        echo "ë„ì»¤ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
        
        # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ë° ê²°ê³¼ ì €ì¥
        CONTAINER_STATUS=$(ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=5 -i ~/.ssh/ec2_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
          if docker ps | grep -q bg-remover; then
            echo "container_up"
          else
            echo "container_down"
          fi
        ')
        
        if [ "$CONTAINER_STATUS" = "container_up" ]; then
          echo "ë„ì»¤ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
          
          # Mattermostì— ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì•Œë¦¼ ì „ì†¡
          curl -X POST -H 'Content-Type: application/json' --data '{
            "text": "### ğŸ“¢ ë°°í¬ ìƒíƒœ ì—…ë°ì´íŠ¸\n**ì €ì¥ì†Œ:** ${{ github.repository }}\n**ë¸Œëœì¹˜:** ${{ github.ref_name }}\nâœ… FastAPI ë„ì»¤ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤..."
          }' ${{ secrets.MATTERMOST_WEBHOOK_URL }}
          
          # Uvicorn ì‹¤í–‰ ë¡œê·¸ í™•ì¸
          echo "ì„œë²„ ì´ˆê¸°í™” ì™„ë£Œ ì—¬ë¶€ í™•ì¸ ì¤‘... (ìµœëŒ€ 2ë¶„ ëŒ€ê¸°)"
          SERVER_READY="false"
          MAX_ATTEMPTS=12  # 10ì´ˆ ê°„ê²©ìœ¼ë¡œ 12ë²ˆ ì²´í¬ (2ë¶„)
          
          for ((i=1; i<=MAX_ATTEMPTS; i++)); do
            echo "í™•ì¸ ì‹œë„ $i/$MAX_ATTEMPTS..."
            SERVER_LOG=$(ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=5 -i ~/.ssh/ec2_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
              docker logs bg-remover 2>&1 | grep -c "Uvicorn running on" || echo "0"
            ')
            
            if [ "$SERVER_LOG" -gt "0" ]; then
              SERVER_READY="true"
              break
            fi
            
            # 10ì´ˆ ëŒ€ê¸° í›„ ë‹¤ì‹œ í™•ì¸
            sleep 10
          done
          
          if [ "$SERVER_READY" = "true" ]; then
            echo "::set-output name=status::success"
            echo "âœ… ì„œë²„ê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
            
            # Mattermostì— ì„œë²„ ì´ˆê¸°í™” ì™„ë£Œ ì•Œë¦¼ ì „ì†¡
            curl -X POST -H 'Content-Type: application/json' --data '{
              "text": "### ğŸ“¢ ë°°í¬ ìƒíƒœ ì—…ë°ì´íŠ¸\n**ì €ì¥ì†Œ:** ${{ github.repository }}\n**ë¸Œëœì¹˜:** ${{ github.ref_name }}\nğŸ‰ ì„œë²„ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n**ì ‘ì† URL:** http://${{ secrets.EC2_HOST }}:${{ secrets.EC2_PORT }}"
            }' ${{ secrets.MATTERMOST_WEBHOOK_URL }}
          else
            echo "::set-output name=status::pending"
            echo "âš ï¸ ë„ì»¤ ì»¨í…Œì´ë„ˆëŠ” ì‹¤í–‰ ì¤‘ì´ë‚˜ ì„œë²„ ì´ˆê¸°í™”ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            
            # ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸
            ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=5 -i ~/.ssh/ec2_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
              echo "ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ë§ˆì§€ë§‰ 30ì¤„):"
              docker logs --tail 30 bg-remover
            '
          fi
        else
          echo "::set-output name=status::failure"
          echo "âŒ ë„ì»¤ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          
          # ë„ì»¤ ì»¨í…Œì´ë„ˆ ë¬¸ì œ í™•ì¸
          ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=5 -i ~/.ssh/ec2_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
            echo "ë„ì»¤ ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            docker ps -a | grep bg-remover
            
            echo "ë„ì»¤ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ë§ˆì§€ë§‰ 30ì¤„):"
            docker logs --tail 30 bg-remover 2>&1 || echo "ë¡œê·¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            
            echo "ë„ì»¤ ì»´í¬ì¦ˆ ë¡œê·¸:"
            cd ~/background-remover && docker-compose -f docker-compose-prod.yml logs
          '
        fi

    # ë°°í¬ ê²°ê³¼ Mattermostë¡œ ì „ì†¡ (ìµœì¢… ìš”ì•½)
    - name: 6. ê²°ê³¼ ì•Œë¦¼ ì „ì†¡
      if: always()
      run: |
        if [ "${{ steps.verify.outputs.status }}" = "success" ]; then
          STATUS="âœ… ì„±ê³µ"
          EMOJI="ğŸ‰"
          MESSAGE="ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
        elif [ "${{ steps.verify.outputs.status }}" = "pending" ]; then
          STATUS="âš ï¸ ì§„í–‰ ì¤‘"
          EMOJI="â³"
          MESSAGE="ë„ì»¤ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì´ë‚˜, ì„œë²„ ì´ˆê¸°í™”ê°€ ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ í™•ì¸í•´ì£¼ì„¸ìš”."
        else
          STATUS="âŒ ì‹¤íŒ¨"
          EMOJI="âš ï¸"
          MESSAGE="ë°°í¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
        fi

        curl -X POST -H 'Content-Type: application/json' --data '{
          "text": "### ğŸ“¢ ë°°í¬ ìµœì¢… ê²°ê³¼: '"$STATUS"'\n**ì €ì¥ì†Œ:** ${{ github.repository }}\n**ë¸Œëœì¹˜:** ${{ github.ref_name }}\n**ì»¤ë°‹:** ${{ github.sha }}\n**ë©”ì‹œì§€:** ${{ github.event.head_commit.message }}\n**ì‹¤í–‰ì:** ${{ github.actor }}\n**ìƒíƒœ:** '"$STATUS $EMOJI"'\n**ë‚´ìš©:** '"$MESSAGE"'\n**ë°°í¬ ë§í¬:** [GitHub Actions ì‹¤í–‰ ê²°ê³¼](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        }' ${{ secrets.MATTERMOST_WEBHOOK_URL }}